services:
  traefik:
    image: traefik:v3.1
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.letsencrypt.acme.email=${TRAEFIK_ACME_EMAIL}
      - --certificatesresolvers.letsencrypt.acme.storage=/acme/acme.json
      - --certificatesresolvers.letsencrypt.acme.httpchallenge=true
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-acme:/acme
    environment:
      - DOCKER_API_VERSION=1.44
    networks:
      - traefik-proxy

  client:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - REACT_APP_STUN_URLS=${REACT_APP_STUN_URLS}
        - REACT_APP_TURN_URLS=${REACT_APP_TURN_URLS}
        - REACT_APP_TURN_USERNAME=${REACT_APP_TURN_USERNAME}
        - REACT_APP_TURN_PASSWORD=${REACT_APP_TURN_PASSWORD}
    depends_on:
      - signaling-server
      - turn-server
    networks:
      - webrtc-network
      - traefik-proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik-proxy
      - traefik.http.services.client.loadbalancer.server.port=80
      - traefik.http.routers.client-web.rule=${TRAEFIK_HOST_RULE}
      - traefik.http.routers.client-web.entrypoints=web
      - traefik.http.routers.client-web.middlewares=redirect-to-https@docker
      - traefik.http.routers.client-websecure.rule=${TRAEFIK_HOST_RULE}
      - traefik.http.routers.client-websecure.entrypoints=websecure
      - traefik.http.routers.client-websecure.tls.certresolver=letsencrypt
      - traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https

  signaling-server:
    build:
      context: ./server
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    networks:
      - webrtc-network

  turn-server:
    image: coturn/coturn:4.5.2
    restart: unless-stopped
    user: root
    command: >
      /bin/sh -c "
        EXTRA_ARGS='';
        if [ -n \"${TURN_EXTERNAL_IP}\" ]; then
          EXTRA_ARGS=\"--external-ip ${TURN_EXTERNAL_IP}\";
        fi;
        turnserver
          --listening-port ${TURN_PORT:-3478}
          --tls-listening-port ${TURN_TLS_PORT:-5349}
          --realm ${TURN_REALM:-webrtc-chat.local}
          --fingerprint
          --lt-cred-mech
          --user ${TURN_USERNAME:-webrtc-user}:${TURN_PASSWORD:-change-me}
          --total-quota=100
          --bps-capacity=0
          --stale-nonce
          --no-multicast-peers
          --no-loopback-peers
          --no-tlsv1
          --no-tlsv1_1
          --pidfile /tmp/turnserver.pid
          --verbose
          $$EXTRA_ARGS
      "
    ports:
      - "${TURN_PORT:-3478}:${TURN_PORT:-3478}"
      - "${TURN_PORT:-3478}:${TURN_PORT:-3478}/udp"
      - "${TURN_TLS_PORT:-5349}:${TURN_TLS_PORT:-5349}"
      - "${TURN_TLS_PORT:-5349}:${TURN_TLS_PORT:-5349}/udp"
    networks:
      - webrtc-network

networks:
  webrtc-network:
    driver: bridge
  traefik-proxy:
    driver: bridge

volumes:
  traefik-acme:
